<!doctype html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      http-equiv="Cache-Control"
      content="no-store, no-cache, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title>Автоінструктор Теремки, Голосієво – Уроки водіння АКПП</title>
    <meta
      name="description"
      content="Індивідуальні уроки водіння з автоінструктором у Києві (Теремки, Голосієво, ВДНГ). АКПП, гнучкий графік, підготовка до іспиту. Записатися онлайн."
    />
    <link rel="stylesheet" href="css/styles.css?v=2.2" />
    <link rel="icon" href="img/favicon.ico" type="image/x-icon" />
  </head>

  <body>
    <header>
      <img
        src="img/holydrivers_logo.png"
        alt="Логотип HolyDrivers"
        class="logo"
      />
      <h1>
        Приватний автоінструктор <br /><span style="font-size: 0.6em"
          >автоматична коробка передач</span
        >
      </h1>
      <div class="home">
        <a href="/">
          <img
            src="img/home.png"
            alt="На головну сторінку приватний автоінсруктор теремки"
          />
          <span>На головну</span>
        </a>
      </div>
    </header>

    <section id="userBar" class="section" style="display: none">
      <span id="userLabel"></span>
      <div id="period_finish" style="display: none"></div>

      <button id="logoutBtn" type="button">Вийти</button>
      <div class="progress-ring" id="user_hours" style="--total: 0; --max: 0">
        <div class="progress-ring__inner">
          <div class="progress-ring__value" id="user_hours_value">0</div>
          <div class="progress-ring-static">годин</div>
        </div>
      </div>
    </section>

    <div class="scheduleContainerPreloader" id="scheduleContainerPreloader">
      <div>Завантаження...</div>
      <div>
        <img
          src="img/giphy.gif"
          alt="завантаження графіку занять автоінструктора"
        />
      </div>
    </div>

    <section class="section" id="userCodeForm">
      <label for="userCodeInput"
        >Для перегляду вашого персонального календаря занять введіть код
        авторизації, наданий вам адміністратором сайту (автоінструктором)</label
      >
      <div>
        <input
          id="userCodeInput"
          type="password"
          autocomplete="off"
          placeholder="Код авторизації"
        />
        <button id="userCodeBtn" type="button">Ок</button>
      </div>
      <div id="userCodeErr" style="display: none">Помилка авторизації</div>
    </section>
    <h3 id="for_new_user">
      <p>
        Обиріть зручний вам вільний слот, повідомте автоінструктора про ваш
        намір записатись на цей час.
      </p>
      <p>
        Дочекайтесь, поки автоінструктор підтвердить ваш запис та приходьте на
        заняття у зазначений день та час. За день до занять вам надійде SMS із
        нагадуванням.
      </p>
      <div class="list">
        <p>&#128994; - слот вільний</p>
        <p>&#9940; - слот зайнятий (проводяться заняття)</p>
        <p>&#9728;&#65039; - неробочі години</p>
        <p>&#127891; - практичні іспити в сервісному центрі МВС</p>
        <p>&#128736;&#65039; - технічне обслуговування автомобіля</p>
      </div>
      <p>
        Якщо ви не знаходите зручних вільних слотів — зв'яжіться з
        автоінструктором, для вас буде виділено додатковий час за рахунок годин,
        що позначені, як неробочі.
      </p>
    </h3>

    <!-- Контейнер для двох місячних таблиць -->
    <div id="scheduleContainer"></div>

    <footer id="contacts">
      <p>Зв'язатись з автоінструктором:</p>
      <div class="contacts">
        <a href="tel:+380632209770" title="Подзвонити" class="contacts-img">
          <img src="img/phone.png" alt="" />
          +38 063 2209770
        </a>

        <a
          href="viber://chat?number=%2B380632209770"
          title="Написати у Viber"
          class="contacts-img"
          target="_blank"
          rel="noopener noreferrer"
        >
          <img src="img/viber.png" alt="" />
          Viber
        </a>
        <a
          href="https://fb.com/holydrivers"
          title="Ми на facebook"
          class="contacts-img"
          target="_blank"
          rel="noopener noreferrer"
        >
          <img src="img/fb.png" alt="Ми на facebook" /> Facebook
        </a>
      </div>
    </footer>
  </body>
</html>

<script>
  const API_URL = "https://holydrivers.com.ua/api/proxy.php";
  const LS_KEY = "user";
  let lastUpdate = null; // останній відомий час оновлення розкладу

  async function checkForScheduleUpdate() {
    try {
      const url = new URL(API_URL);
      url.searchParams.set("mode", "getlastupdate");

      const res = await fetch(url.toString(), { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const data = await res.json(); // очікуємо: { lastUpdate: "2025-12-20 19:12:34" } або null
      if (!data || !data.lastUpdate) {
        // нічого не змінюємо, якщо Apps Script ще нічого не записав
        return;
      }

      // якщо перший раз — просто запам'ятали і нічого не перезавантажуємо
      if (lastUpdate === null) {
        lastUpdate = data.lastUpdate;
        return;
      }

      // якщо час змінився — оновлюємо розклад
      if (data.lastUpdate !== lastUpdate) {
        console.log("Schedule updated at", data.lastUpdate);
        lastUpdate = data.lastUpdate;
        await loadSchedules({ silent: true }); // перетягуємо нові дані й перерисовуємо таблицю
      }
    } catch (err) {
      console.error("Не вдалося перевірити оновлення розкладу:", err);
    }
  }

  function updateUserBar(fullname, id, totalHours, maxHours, finishDate) {
    const bar = document.getElementById("userBar");
    const label = document.getElementById("userLabel");
    const error = document.getElementById("userCodeErr");
    const codeForm = document.getElementById("userCodeForm");
    const ring = document.getElementById("user_hours");
    const ringValue = document.getElementById("user_hours_value");
    const periodFinish = document.getElementById("period_finish");
    const total = Number(totalHours) || 0;
    const max = Number(maxHours) || 0;

    if (error) error.style.display = "none";

    if (fullname && String(fullname).trim() !== "") {
      console.log("ok");
      if (label) label.textContent = `Користувач: ${fullname}`;
      if (periodFinish) {
        const f = finishDate ? String(finishDate).trim() : "";
        periodFinish.innerHTML = `Практичні заняття Вам слід закінчити не пізніше <b>${f}</b>`;
        if (f) {
          periodFinish.style.display = "";
        } else periodFinish.style.display = "none";
      }
      if (bar) bar.style.display = "";
      if (codeForm) codeForm.style.display = "none";

      if (ring) {
        ring.style.setProperty("--total", total);
        ring.style.setProperty("--max", max || 1);
        if (ringValue) ringValue.textContent = String(total);
        // якщо max == 0 / порожнє / не задано => 100%
        ring.style.display = max ? "flex" : "none";
      }
      // document.getElementById("for_new_user").style.display = "none";
    } else {
      // console.log("error");
      // console.log(id);
      if (periodFinish) periodFinish.style.display = "none";
      if (bar) bar.style.display = "none";
      if (id && String(id).trim() !== "") {
        if (error) error.style.display = "";
      } // якщо user_id повернувся, а user_fullname - ні, то вважаємо, що авторизація не пройшла
      if (codeForm) codeForm.style.display = "";
      document.getElementById("for_new_user").style.display = "";
    }
  }

  function attachLogout() {
    const btn = document.getElementById("logoutBtn");
    if (!btn) return;
    btn.addEventListener("click", () => {
      try {
        localStorage.removeItem("user");
      } catch (_) {}
      // Приберемо ?user з адресного рядка (без перезавантаження)
      try {
        const url = new URL(location.href);
        url.searchParams.delete("user");
        history.replaceState({}, "", url.toString());
      } catch (_) {}
      updateUserBar("");
      // Якщо у тебе є форма введення коду — можна її показати тут
      const form = document.getElementById("userCodeForm");
      if (form) form.style.display = "";
      // Перечитати розклад без user
      loadSchedules({ silent: false });
    });
  }

  // Викличи attachLogout один раз після завантаження DOM
  document.addEventListener("DOMContentLoaded", attachLogout);

  // Якщо код прийшов у URL — просто збережемо як є (без перевірок)
  (function bootstrapUserFromURL() {
    const u = new URLSearchParams(location.search).get("user");
    if (u != null) {
      try {
        localStorage.setItem(LS_KEY, u);
      } catch (_) {}
    }
  })();

  function getUserId() {
    try {
      return localStorage.getItem(LS_KEY);
    } catch (_) {
      return null;
    }
  }

  function setUserId(u) {
    try {
      localStorage.setItem(LS_KEY, String(u));
      return true;
    } catch (_) {
      return false;
    }
  }

  function toggleUserForm(show) {
    const form = document.getElementById("userCodeForm");
    if (form) form.style.display = show ? "" : "none";
  }

  function initUserForm() {
    const input = document.getElementById("userCodeInput");
    const btn = document.getElementById("userCodeBtn");
    const err = document.getElementById("userCodeErr");

    function submit() {
      if (err) err.style.display = "none"; // ✅ сховати помилку при новій спробі
      const val = input ? input.value : "";
      if (input) input.value = "";

      // err.textContent = "";
      if (setUserId(val)) {
        toggleUserForm(false);
        if (typeof loadSchedules === "function")
          loadSchedules({ silent: false });
      } else {
        // err.textContent = "Не вдалося зберегти код у браузері.";
      }
    }

    if (btn) btn.addEventListener("click", submit);
    if (input)
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") submit();
      });
  }

  document.addEventListener("DOMContentLoaded", () => {
    initUserForm();

    const u = getUserId();
    toggleUserForm(u === null);

    if (typeof loadSchedules === "function") {
      loadSchedules({ silent: false });
    }
  });

  let scheduleInterval = null;

  function startScheduleWatcher() {
    if (scheduleInterval !== null) return; // вже запущений
    scheduleInterval = setInterval(checkForScheduleUpdate, 20000);
  }

  function stopScheduleWatcher() {
    if (scheduleInterval !== null) {
      clearInterval(scheduleInterval);
      scheduleInterval = null;
    }
  }

  // стартуємо відкладено, щоб не грузити одразу
  setTimeout(() => {
    checkForScheduleUpdate(); // перша перевірка
    startScheduleWatcher(); // далі — з повтором
  }, 5000);

  function getCellClass(value) {
    if (value == null) return "";
    const v = value.toString().trim();
    if (v === "&#127891;") return "exam";
    return "";
  }

  document.addEventListener("visibilitychange", () => {
    if (document.hidden) {
      stopScheduleWatcher(); // вкладка неактивна
    } else {
      checkForScheduleUpdate(); // одразу перевірити
      startScheduleWatcher(); // і знову інтервал
    }
  });

  const getTitle = (value) => {
    // title для слотів
    const v = String(value).trim();

    switch (v) {
      case "&#128994;":
        return "вільно";
      case "&#127891;":
        return "іспит";
      case "&#9940;":
        return "зайнято";
      case "&#9728;&#65039;":
        return "вихідний";
      case "&#128736;&#65039;":
        return "техобслуговування";
      default:
        return "";
    }
  };

  // Рендер одного місяця (або повідомлення, якщо даних немає)
  function renderMonthBlock(label, payload) {
    if (!payload) {
      return `
        <h3 class="section-title" style="margin-top:1rem;">${label}</h3>
        <div class="schedule">
          <div style="width:100%;text-align:center;color:#ccc;padding:8px 0;">
            Запис на цей місяць не розпочато
          </div>
        </div>
      `;
    }

    // Ліва колонка
    const leftHtml = (payload.leftCol || [])
      .map((v) => {
        const value = v != null && v.toString().trim() !== "" ? v : "";
        return `<tr><td >${value}</td></tr>`;
      })
      .join("");

    // Права таблиця

    const rightHtml = (payload.rightCols || [])
      .map((row) => {
        const tds = row
          .map((cell) => {
            const value =
              cell != null && cell.toString().trim() !== "" ? cell : "";
            const title = getTitle(value);
            const titleAttr = title ? ` title="${title}"` : "";

            return `<td><span ${titleAttr} class="${getCellClass(
              cell,
            )}">${value}</span></td>`;
          })
          .join("");
        return `<tr>${tds}</tr>`;
      })
      .join("");

    return `
      <h3 class="section-title" style="margin-top:1rem;">${payload.month}</h3>
      <div class="schedule">
        <div class="left">
          <table><tbody>${leftHtml}</tbody></table>
        </div>
        <div class="right">
          <table><tbody>${rightHtml}</tbody></table>
        </div>
      </div>
    `;
  }

  // Основне завантаження: тягнемо JSON { current, next } і рендеримо 2 таблиці
  async function loadSchedules({ silent = false } = {}) {
    const container = document.getElementById("scheduleContainer");
    const preloader = document.getElementById("scheduleContainerPreloader");
    const form = document.getElementById("userCodeForm");

    let user = "";
    try {
      const u = localStorage.getItem("user");
      if (u && u !== "null" && u !== "undefined" && u.trim() !== "") {
        user = u.trim();
      }
    } catch (_) {}

    if (!silent && preloader) {
      if (preloader) preloader.style.display = "";
      if (form) form.style.display = "none";
    }

    try {
      const url = new URL(API_URL);
      if (user) url.searchParams.set("user", user);

      const res = await fetch(url.toString(), { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json(); // очікуємо: { current: {...}|null, next: {...}|null }
      updateUserBar(
        data.user_fullname,
        data.user_id,
        data.total_hours,
        data.user_maxhours,
        data.finishDate,
      );
      console.log("res:", data);
      const html =
        renderMonthBlock("Поточний місяць", data.current) +
        renderMonthBlock("Наступний місяць", data.next);

      container.innerHTML = html;
      if (preloader) preloader.style.display = "none";
      // if (form) form.style.display = "";
    } catch (err) {
      container.innerHTML = `<div style="color:red;">Помилка: ${err.message}</div>`;
      if (form) form.style.display = "";
      if (preloader) preloader.style.display = "none";
    }
  }

  //  Старт (передай ім'я користувача за потреби)
  // loadSchedules()
</script>
