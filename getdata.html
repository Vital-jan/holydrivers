<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      http-equiv="Cache-Control"
      content="no-store, no-cache, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title>–ê–≤—Ç–æ—ñ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –¢–µ—Ä–µ–º–∫–∏, –ì–æ–ª–æ—Å—ñ—î–≤–æ ‚Äì –£—Ä–æ–∫–∏ –≤–æ–¥—ñ–Ω–Ω—è –ê–ö–ü–ü</title>
    <meta
      name="description"
      content="–Ü–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω—ñ —É—Ä–æ–∫–∏ –≤–æ–¥—ñ–Ω–Ω—è –∑ –∞–≤—Ç–æ—ñ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–æ–º —É –ö–∏—î–≤—ñ (–¢–µ—Ä–µ–º–∫–∏, –ì–æ–ª–æ—Å—ñ—î–≤–æ, –í–î–ù–ì). –ê–ö–ü–ü, –≥–Ω—É—á–∫–∏–π –≥—Ä–∞—Ñ—ñ–∫, –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ —ñ—Å–ø–∏—Ç—É. –ó–∞–ø–∏—Å–∞—Ç–∏—Å—è –æ–Ω–ª–∞–π–Ω."
    />
    <link rel="stylesheet" href="css/styles.css?v=1.85" />
    <link rel="icon" href="img/favicon.ico" type="image/x-icon" />
  </head>

  <body>
    <header>
      <img
        src="img/holydrivers_logo.png"
        alt="–õ–æ–≥–æ—Ç–∏–ø HolyDrivers"
        class="logo"
      />
      <h1>
        –ü—Ä–∏–≤–∞—Ç–Ω–∏–π –∞–≤—Ç–æ—ñ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä <br /><span style="font-size: 0.6em"
          >–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –∫–æ—Ä–æ–±–∫–∞ –ø–µ—Ä–µ–¥–∞—á</span
        >
      </h1>
      <div class="home">
        <a href="/">
          <img
            src="img/home.png"
            alt="–ù–∞ –≥–æ–ª–æ–≤–Ω—É —Å—Ç–æ—Ä—ñ–Ω–∫—É –ø—Ä–∏–≤–∞—Ç–Ω–∏–π –∞–≤—Ç–æ—ñ–Ω—Å—Ä—É–∫—Ç–æ—Ä —Ç–µ—Ä–µ–º–∫–∏"
          />
          <span>–ù–∞ –≥–æ–ª–æ–≤–Ω—É</span>
        </a>
      </div>
    </header>

    <section id="userBar" class="section" style="display: none">
      <span id="userLabel"></span>
      <button id="logoutBtn" type="button">–í–∏–π—Ç–∏</button>
    </section>

    <section class="section" id="userCodeForm">
      <label for="userCodeInput"
        >–î–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –í–∞—à–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –≤–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó,
        –Ω–∞–¥–∞–Ω–∏–π –í–∞–º –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º —Å–∞–π—Ç—É</label
      >
      <div>
        <input
          id="userCodeInput"
          type="text"
          autocomplete="off"
          placeholder="–ö–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó"
        />
        <button id="userCodeBtn" type="button">–û–∫</button>
      </div>
      <div id="userCodeErr"></div>
    </section>
    <h3 id="for_new_user">
      –Ø–∫—â–æ –í–∏ —Ö–æ—á–µ—Ç–µ —Ä–æ–∑–ø–æ—á–∞—Ç–∏ –∑–∞–Ω—è—Ç—Ç—è, –∞–ª–µ –Ω–µ –∑–Ω–∞—Ö–æ–¥–∏—Ç–µ –≤—ñ–ª—å–Ω–∏—Ö —Å–ª–æ—Ç—ñ–≤ ‚Äî
      –∑–≤'—è–∂—ñ—Ç—å—Å—è –∑ —ñ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–æ–º, –¥–ª—è –í–∞—Å –±—É–¥–µ –≤–∏–¥—ñ–ª–µ–Ω–æ –¥–æ–¥–∞—Ç–∫–æ–≤–∏–π —á–∞—Å.
    </h3>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–≤–æ—Ö –º—ñ—Å—è—á–Ω–∏—Ö —Ç–∞–±–ª–∏—Ü—å -->
    <div id="scheduleContainer">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>

    <footer id="contacts">
      <p>–ó–≤'—è–∑–∞—Ç–∏—Å—å –∑ –∞–≤—Ç–æ—ñ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–æ–º:</p>
      <div class="contacts">
        <a href="tel:+380632209770" title="–ü–æ–¥–∑–≤–æ–Ω–∏—Ç–∏" class="contacts-img">
          <img src="img/phone.png" alt="" />
          +38 063 2209770
        </a>

        <a
          href="viber://chat?number=%2B380632209770"
          title="–ù–∞–ø–∏—Å–∞—Ç–∏ —É Viber"
          class="contacts-img"
          target="_blank"
          rel="noopener noreferrer"
        >
          <img src="img/viber.png" alt="" />
          Viber
        </a>
        <a
          href="https://fb.com/holydrivers"
          title="–ú–∏ –Ω–∞ facebook"
          class="contacts-img"
          target="_blank"
          rel="noopener noreferrer"
        >
          <img src="img/fb.png" alt="–ú–∏ –Ω–∞ facebook" /> Facebook
        </a>
      </div>
    </footer>
  </body>
</html>

<script>
  function updateUserBar(fullname) {
    const bar = document.getElementById("userBar");
    const label = document.getElementById("userLabel");
    if (fullname && String(fullname).trim() !== "") {
      if (label) label.textContent = `–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: ${fullname}`;
      if (bar) bar.style.display = "";
      document.getElementById("for_new_user").style.display = "none";
    } else {
      if (bar) bar.style.display = "none";
      document.getElementById("for_new_user").style.display = "";
    }
  }

  function attachLogout() {
    const btn = document.getElementById("logoutBtn");
    if (!btn) return;
    btn.addEventListener("click", () => {
      try {
        localStorage.removeItem("user");
      } catch (_) {}
      // –ü—Ä–∏–±–µ—Ä–µ–º–æ ?user –∑ –∞–¥—Ä–µ—Å–Ω–æ–≥–æ —Ä—è–¥–∫–∞ (–±–µ–∑ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è)
      try {
        const url = new URL(location.href);
        url.searchParams.delete("user");
        history.replaceState({}, "", url.toString());
      } catch (_) {}
      updateUserBar("");
      // –Ø–∫—â–æ —É —Ç–µ–±–µ —î —Ñ–æ—Ä–º–∞ –≤–≤–µ–¥–µ–Ω–Ω—è –∫–æ–¥—É ‚Äî –º–æ–∂–Ω–∞ —ó—ó –ø–æ–∫–∞–∑–∞—Ç–∏ —Ç—É—Ç
      const form = document.getElementById("userCodeForm");
      if (form) form.style.display = "";
      // –ü–µ—Ä–µ—á–∏—Ç–∞—Ç–∏ —Ä–æ–∑–∫–ª–∞–¥ –±–µ–∑ user
      loadSchedules();
    });
  }

  // –í–∏–∫–ª–∏—á–∏ attachLogout –æ–¥–∏–Ω —Ä–∞–∑ –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è DOM
  document.addEventListener("DOMContentLoaded", attachLogout);

  const LS_KEY = "user";

  // –Ø–∫—â–æ –∫–æ–¥ –ø—Ä–∏–π—à–æ–≤ —É URL ‚Äî –ø—Ä–æ—Å—Ç–æ –∑–±–µ—Ä–µ–∂–µ–º–æ —è–∫ —î (–±–µ–∑ –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫)
  (function bootstrapUserFromURL() {
    const u = new URLSearchParams(location.search).get("user");
    if (u != null) {
      try {
        localStorage.setItem(LS_KEY, u);
      } catch (_) {}
    }
  })();

  function getUserId() {
    try {
      return localStorage.getItem(LS_KEY);
    } catch (_) {
      return null;
    }
  }

  function setUserId(u) {
    try {
      localStorage.setItem(LS_KEY, String(u));
      return true;
    } catch (_) {
      return false;
    }
  }

  function toggleUserForm(show) {
    const form = document.getElementById("userCodeForm");
    if (form) form.style.display = show ? "" : "none";
  }

  function initUserForm() {
    const input = document.getElementById("userCodeInput");
    const btn = document.getElementById("userCodeBtn");
    const err = document.getElementById("userCodeErr");

    function submit() {
      const val = input ? input.value : "";
      err.textContent = "";
      if (setUserId(val)) {
        toggleUserForm(false);
        if (typeof loadSchedules === "function") loadSchedules(val);
      } else {
        err.textContent = "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –∫–æ–¥ —É –±—Ä–∞—É–∑–µ—Ä—ñ.";
      }
    }

    if (btn) btn.addEventListener("click", submit);
    if (input)
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") submit();
      });
  }

  document.addEventListener("DOMContentLoaded", () => {
    initUserForm();
    const u = getUserId();
    if (u !== null) {
      toggleUserForm(false);
      if (typeof loadSchedules === "function") loadSchedules(u);
    } else {
      toggleUserForm(true);
    }
  });

  // üîß –í–∫–∞–∂–∏ —Å–≤—ñ–π –ø—Ä–æ–∫—Å—ñ/–±–µ–∫–µ–Ω–¥, —è–∫–∏–π –ø–æ–≤–µ—Ä—Ç–∞—î { current, next }
  // –Ø–∫—â–æ –Ω–∞ VPS —î proxy.php, —è–∫–∏–π –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–∫–∏–¥–∞—î –∑–∞–ø–∏—Ç –¥–æ Apps Script:
  // –¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ª–∏—à–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ user (month –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω)
  const API_URL = "https://holydrivers.com.ua/api/proxy.php";

  function getCellClass(value) {
    if (value == null) return "";
    const v = value.toString().trim().toLowerCase();
    if (v === "–≤—ñ–ª—å–Ω–æ") return "free";
    if (v === "—ñ—Å–ø–∏—Ç") return "exam";
    return "";
  }

  // –†–µ–Ω–¥–µ—Ä –æ–¥–Ω–æ–≥–æ –º—ñ—Å—è—Ü—è (–∞–±–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, —è–∫—â–æ –¥–∞–Ω–∏—Ö –Ω–µ–º–∞—î)
  function renderMonthBlock(label, payload) {
    if (!payload) {
      return `
        <h3 class="section-title" style="margin-top:1rem;">${label}</h3>
        <div class="schedule">
          <div style="width:100%;text-align:center;color:#ccc;padding:8px 0;">
            –î–∞–Ω—ñ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ (–∞—Ä–∫—É—à –º—ñ—Å—è—Ü—è –≤—ñ–¥—Å—É—Ç–Ω—ñ–π)
          </div>
        </div>
      `;
    }

    // –õ—ñ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞
    const leftHtml = (payload.leftCol || [])
      .map((v) => {
        const value = v != null && v.toString().trim() !== "" ? v : "&nbsp;";
        return `<tr><td>${value}</td></tr>`;
      })
      .join("");

    // –ü—Ä–∞–≤–∞ —Ç–∞–±–ª–∏—Ü—è
    const rightHtml = (payload.rightCols || [])
      .map((row) => {
        const tds = row
          .map((cell) => {
            const value =
              cell != null && cell.toString().trim() !== "" ? cell : "&nbsp;";
            return `<td class="${getCellClass(cell)}">${value}</td>`;
          })
          .join("");
        return `<tr>${tds}</tr>`;
      })
      .join("");

    return `
      <h3 class="section-title" style="margin-top:1rem;">${payload.month}</h3>
      <div class="schedule">
        <div class="left">
          <table><tbody>${leftHtml}</tbody></table>
        </div>
        <div class="right">
          <table><tbody>${rightHtml}</tbody></table>
        </div>
      </div>
    `;
  }

  // –û—Å–Ω–æ–≤–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: —Ç—è–≥–Ω–µ–º–æ JSON { current, next } —ñ —Ä–µ–Ω–¥–µ—Ä–∏–º–æ 2 —Ç–∞–±–ª–∏—Ü—ñ
  async function loadSchedules() {
    let user = "";
    try {
      const u = localStorage.getItem("user");
      if (u && u !== "null" && u !== "undefined" && u.trim() !== "") {
        user = u.trim();
      }
    } catch (_) {}

    const container = document.getElementById("scheduleContainer");
    container.innerHTML = "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶";

    try {
      const url = new URL(API_URL);
      if (user) url.searchParams.set("user", user);

      const res = await fetch(url.toString(), { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json(); // –æ—á—ñ–∫—É—î–º–æ: { current: {...}|null, next: {...}|null }
      updateUserBar(data.user_fullname);
      console.log("res:", data);
      const html =
        renderMonthBlock("–ü–æ—Ç–æ—á–Ω–∏–π –º—ñ—Å—è—Ü—å", data.current) +
        renderMonthBlock("–ù–∞—Å—Ç—É–ø–Ω–∏–π –º—ñ—Å—è—Ü—å", data.next);

      container.innerHTML = html;
    } catch (err) {
      container.innerHTML = `<div style="color:red;">–ü–æ–º–∏–ª–∫–∞: ${err.message}</div>`;
    }
  }

  // üöÄ –°—Ç–∞—Ä—Ç (–ø–µ—Ä–µ–¥–∞–π —ñ–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞ –ø–æ—Ç—Ä–µ–±–∏)
  loadSchedules();
</script>
